---
title: Delayed Certificate Activation
authors:
  - "@jaingeet"
reviewers:
 - @jetstack/team-cert-manager
approvers:
 - @jetstack/team-cert-manager
editor: "@jaingeet"
creation-date: 2024-09-18
last-updated: 2024-09-18
status: implementable
---

# Delayed Certificate Activation

## Table of Contents

<!-- toc -->
- [Delayed Certificate Activation](#delayed-certificate-activation)
  - [Table of Contents](#table-of-contents)
  - [Summary](#summary)
  - [Motivation](#motivation)
    - [Goals](#goals)
    - [Non-Goals](#non-goals)
  - [Proposal](#proposal)
    - [API changes](#api-changes)
    - [Examples](#examples)
      - [Issuance with Future NotBefore](#issuance-with-future-notbefore)
      - [Renewal with NotBefore](#renewal-with-notbefore)
      - [Invalid Configuration: NotAfter Before NotBefore](#invalid-configuration-notafter-before-notbefore)
  - [Implementation Considerations](#implementation-considerations)
  - [Backward Compatibilty](#backward-compatibilty)
    - [Test Plan](#test-plan)
      - [Unit Tests](#unit-tests)
    - [Upgrading](#upgrading)
    - [Misc](#misc)
  - [Alternatives](#alternatives)
<!-- /toc -->

## Summary

This proposal introduces a mechanism to specify a future `NotBefore` time in cert-manager certificates, enabling delayed activation of issued certificates.

## Motivation

Currently, cert-manager creates the Certificate Signing Request (CSR) with `NotBefore` set to the current time (`time.Now()`).  This prevents use cases where a certificate needs to be issued in advance but only become valid at a specific future time. For example,

**Pre-provisioning Certificates:** Generating certificates for resources that will be deployed in the future, such as for a scheduled application rollout.
**Compliance Requirements:** Adhering to specific security policies that mandate a future validation start date for certificates.

Supporting a future `NotBefore` time aligns with the capabilities of x509.CertificateRequest and provides greater flexibility in certificate management.

### Goals

- Extend the `Certificate` and `CertificateRequest` APIs to allow specifying a future `NotBefore` time.
- Update the `CertificateRequest` controller to honor the specified NotBefore time when creating x509.CertificateRequests.
- Maintain backward compatibility with existing certificate issuance workflows.

### Non-Goals

- This proposal does not aim to change the behavior of existing certificates without a NotBefore field.

## Proposal

Introduce two new optional fields, `NotBefore` and `NotAfter`, to the spec of both `Certificate` and `CertificateRequest` resources. These fields will allow users to explicitly define the validity period of the certificate.

### API changes

```
type CertificateSpec struct {
  // EXISTING FIELDS
  // ...

  // NotBefore defines the time when the certificate becomes valid.
  // If omitted or set to a time in the past, the certificate will be 
  // valid immediately upon issuance.
  // +optional
  NotBefore *metav1.Time `json:"notBefore,omitempty"`

  // NotAfter defines the time when the certificate expires.
  // If omitted or set to a time in the past, NotAfter will be calculated
  // as NotBefore + Duration. 
  // If both are omitted, the certificate will
  // fallback to the previous logic to use duration.
  // +optional
  NotAfter *metav1.Time `json:"notAfter,omitempty"`
}

type CertificateRequestSpec struct {
  // EXISTING FIELDS
  // ...

  // NotBefore defines the time when the certificate becomes valid.
  // If omitted or set to a time in the past, the certificate will be 
  // valid immediately upon issuance.
  // +optional
  NotBefore *metav1.Time `json:"notBefore,omitempty"`

  // NotAfter defines the time when the certificate expires.
  // If omitted or set to a time in the past, NotAfter will be calculated
  // as NotBefore + Duration. 
  // If both are omitted, the certificate will
  // fallback to the previous logic to use duration.
  // +optional
  NotAfter *metav1.Time `json:"notAfter,omitempty"` 
}
```

### Examples

#### Issuance with Future NotBefore

```
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: example-cert
spec:
  secretName: example-cert-tls
  issuerRef:
    name: letsencrypt-prod
    kind: ClusterIssuer
  commonName: example.com
  notBefore: "2024-10-01T10:00:00Z" 
  duration: 2160h # 90 days
```

This example creates a certificate that will only become valid on October 1st, 2024, even if it is issued earlier.

#### Renewal with NotBefore

When a certificate with a future`NotBefore` is renewed, cert-manager should preserve the original `NotBefore` time if it's still in the future. If the original `NotBefore` is in the past, the renewed certificate should be valid immediately.

#### Invalid Configuration: NotAfter Before NotBefore

The following configuration should be rejected by the webhook as invalid:

```
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: example-cert
spec:
  # ...
  notBefore: "2024-10-01T10:00:00Z"
  notAfter: "2024-09-20T10:00:00Z" 
```

## Implementation Considerations

**Validation:** The cert-manager webhook should validate that if both `NotBefore` and `NotAfter` are set, `NotBefore` precedes `NotAfter`.

**Defaults:**

- If `NotBefore` is omitted or set to a time in the past (can happen during renewal), the current time should be used.
- If `NotAfter` is omitted set to a time in the past, NotAfter should be calculated as `NotBefore + Duration`.

## Backward Compatibilty

This proposal maintains backward compatibility. Existing `Certificate` and `CertificateRequest` resources without the new fields will continue to function as they currently do, with `NotBefore` defaulting to the current time.

### Test Plan

#### Unit Tests

Comprehensive unit tests will be added to cover all combinations of `NotBefore`, `NotAfter`, and `Duration`, including:

- `NotBefore` nil, `NotAfter` not nil
- `NotBefore` not nil, `NotAfter` nil
- `NotBefore` and `NotAfter` not nil
- `NotBefore` and `NotAfter` nil
- `NotAfter` preceding `NotBefore`

### Upgrading

As these are optional fields, upgrading to a cert-manager version with these new fields or downgrading to one without them should not require extra steps or cause unnecessary re-issuances.

### Misc

The cert-manager documentation will be updated to include details about this feature, usage with examples.

## Alternatives

Instead of adding new optional fields to Certificate and CertificateRequest API, we can propose two annotation and that can be used to define the `NotBefore` and `NotAfter` time for the certificate validations.
