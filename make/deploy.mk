# On arm64, you can force the use of amd64 images:
#
#   make deploy CRI_ARCH=amd64
#   make kind-load CRI_ARCH=amd64
#
CRI_ARCH ?= $(HOST_ARCH)

# The commas in FEATURE_GATES have been kept for backwards compatibility with
# our previous Bazel/scripts.
FEATURE_GATES ?= AdditionalCertificateOutputFormats=true,ExperimentalCertificateSigningRequestControllers=true,ExperimentalGatewayAPISupport=true,ServerSideApply=true

# In make, there is no way to escape commas or spaces. So we use the variables
# $(space) and $(comma) instead.
null  =
space = $(null) #
comma = ,

FEATURE_GATES_CONTROLLER = $(subst $(space),$(comma),$(filter AllAlpha=% AllBeta=% AdditionalCertificateOutputFormats=% ValidateCAA=% ExperimentalCertificateSigningRequestControllers=% ExperimentalGatewayAPISupport=% ServerSideApply=%, $(subst $(comma),$(space),$(FEATURE_GATES))))
FEATURE_GATES_WEBHOOK = $(subst $(space),$(comma),$(filter AllAlpha=% AllBeta=% AdditionalCertificateOutputFormats=% , $(subst $(comma),$(space),$(FEATURE_GATES))))
FEATURE_GATES_CAINJECTOR = $(subst $(space),$(comma),$(filter AllAlpha=% AllBeta=%, $(subst $(comma),$(space),$(FEATURE_GATES))))

# generated by ./hack/latest-kind-images.sh
KIND_IMAGE_SHA_K8S_1.18=sha256:f4bcc97a0ad6e7abaf3f643d890add7efe6ee4ab90baeb374b4f41a4c95567eb
KIND_IMAGE_SHA_K8S_1.19=sha256:a70639454e97a4b733f9d9b67e12c01f6b0297449d5b9cbbef87473458e26dca
KIND_IMAGE_SHA_K8S_1.20=sha256:cbeaf907fc78ac97ce7b625e4bf0de16e3ea725daf6b04f930bd14c67c671ff9
KIND_IMAGE_SHA_K8S_1.21=sha256:0fda882e43d425622f045b492f8bd83c2e0b4984fc03e2e05ec101ca1a685fb7
KIND_IMAGE_SHA_K8S_1.22=sha256:f240c00ffb1d82a2a2225ca0f5c85d1c45aa2b97921327cb3f6da4eee7eae5c3
KIND_IMAGE_SHA_K8S_1.23=sha256:49824ab1727c04e56a21a5d8372a402fcd32ea51ac96a2706a12af38934f81ac

K8S_VERSION = 1.23

# Creates a Kind cluster and wait for all nodes to be ready.
KIND_CLUSTER_NAME ?= kind
.PHONY: kind-cluster
kind-cluster: devel/cluster/config/v1beta2.yaml | ${KIND} ${KUBECTL}
	@if [ -z "${KIND_IMAGE_SHA_K8S_$(K8S_VERSION)}" ]; then echo "this K8S_VERSION is not supported"; exit 1; fi
	@${KIND} get clusters | grep -q ${KIND_CLUSTER_NAME} || \
		${KIND} create cluster --config $< --name ${KIND_CLUSTER_NAME} --wait 5m --image docker.io/kindest/node@${KIND_IMAGE_SHA_K8S_$(K8S_VERSION)}
	@if test "$$(kubectl config current-context 2>/dev/null)" != kind-${KIND_CLUSTER_NAME}; then \
		printf "$(Y)$(WARN)Warning$(E): your current kubectl context isn't equal to kind-${KIND_CLUSTER_NAME}. Run the following command:\n" >&2; \
		printf "    $(C)kubectl config use-context kind-${KIND_CLUSTER_NAME}$(E)\n" >&2; \
		exit 1; \
	fi

# Checks that the locally-built images are available in the Kind cluster. The
# Kind cluster can be created with:
#
#   make kind-cluster
#
# Note that "docker" is not considered as a dependency that we would need to
# fetch in tools.mk because Kind itself depends on the docker binary.
image-check: bin/containers/cert-manager-controller-linux-$(CRI_ARCH).tar.gz bin/containers/cert-manager-acmesolver-linux-$(CRI_ARCH).tar.gz bin/containers/cert-manager-cainjector-linux-$(CRI_ARCH).tar.gz bin/containers/cert-manager-webhook-linux-$(CRI_ARCH).tar.gz bin/containers/cert-manager-ctl-linux-$(CRI_ARCH).tar.gz | ${KUBECTL}
	@$(eval export IMAGES = $(foreach tar,$^,$(shell tar xzfO $(tar) manifest.json | jq '.[0].RepoTags[0]' -r)))
	@if ! (${KUBECTL} get nodes -ojson | jq '.items[0].spec.providerID' -r | grep -q ^kind 2>/dev/null && \
			docker exec $$(${KUBECTL} get nodes -ojson | jq '.items[0].metadata.name' -r) crictl inspecti $(IMAGES) 2>/dev/null >&2); then \
		printf "$(R)$(REDCROSS)Error$(E): the image $(IMAGE) wasn't found (note that only Kind is supported). Try running:\n">&2; \
		printf "    $(C)make kind-load$(E)\n" >&2; \
		exit 1; \
	fi

.PHONY: kind-load
kind-load: bin/containers/cert-manager-controller-linux-$(CRI_ARCH).tar.gz bin/containers/cert-manager-acmesolver-linux-$(CRI_ARCH).tar.gz bin/containers/cert-manager-cainjector-linux-$(CRI_ARCH).tar.gz bin/containers/cert-manager-webhook-linux-$(CRI_ARCH).tar.gz bin/containers/cert-manager-ctl-linux-$(CRI_ARCH).tar.gz | ${KIND} ${KUBECTL}
	@if ! ${KUBECTL} get nodes -ojson | jq '.items[0].spec.providerID' -r | grep -q ^kind 2>/dev/null; then \
		printf "$(R)$(REDCROSS)Error$(E): the current context is not a Kind cluster. Try running:\n">&2; \
		printf "    $(C)make kind-cluster$(E)\n" >&2; \
		exit 1; \
	fi
	tr ' ' '\n' <<<"$^" | xargs -I@ -P$(words $^) sh -c "gzip -c -d @ | ${KIND} load image-archive /dev/stdin --name $$(kubectl get nodes -ojson | jq '.items[0].spec.providerID' -r | cut -d/ -f4)"

bin/containers/%.manifest.json: bin/containers/%.tar.gz
	cd $(dir $@) && tar zxf ../../$< manifest.json
	touch $@

.PHONY: deploy
deploy: bin/cert-manager-$(RELEASE_VERSION).tgz image-check
	${HELM_CMD} upgrade --install --wait --create-namespace --namespace cert-manager \
	 	--set installCRDs=true \
	 	--set image.repository=cert-manager-controller-amd64 \
	 	--set cainjector.image.repository=cert-manager-cainjector-amd64 \
	 	--set webhook.image.repository=cert-manager-webhook-amd64 \
	 	--set startupapicheck.image.repository=cert-manager-ctl-amd64 \
	 	--set image.tag=$(RELEASE_VERSION) \
	 	--set cainjector.image.tag=$(RELEASE_VERSION) \
	 	--set webhook.image.tag=$(RELEASE_VERSION) \
	 	--set startupapicheck.image.tag=$(RELEASE_VERSION) \
	 	--set featureGates="$(subst $(comma),\$(comma),FEATURE_GATES_CONTROLLER)" \
	 	--set "webhook.extraArgs={--feature-gates=$(FEATURE_GATES_WEBHOOK)}" \
	 	--set "cainjector.extraArgs={--feature-gates=$(FEATURE_GATES_CAINJECTOR)}"\
	 	--set "extraArgs={--dns01-recursive-nameservers=${SERVICE_IP_PREFIX}.16:53,--dns01-recursive-nameservers-only=true}" \
	 	cert-manager $<

# If you would prefer the ANSI color characters and emojis not to appear, you
# can set NO_COLOR=1 (https://no-color.org/).
ifeq ($(NO_COLOR),)
R=\033[0;31m
G=\033[0;32m
Y=\033[0;33m
# C = cyan
C=\033[0;36m
# B = white bold
B=\033[0;37m
GR=\033[0;90m
# E is the "end" marker.
E=\033[0m
WARN=⚠️  #
WAIT=⏳️  #
GREENCHECK=✅  #
REDCROSS=❌  #
endif

